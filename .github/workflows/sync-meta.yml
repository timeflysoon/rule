# æ–‡ä»¶å: .github/workflows/sync-meta.yml
# æ—¥å¸¸ä½¿ç”¨çš„åŒæ­¥å·¥ä½œæµ - ä¸æºä»“åº“å®Œå…¨ä¸€è‡´

name: Sync Meta Folders Only

on:
  schedule:
    - cron: '30 18 * * *'  # UTC 18:30 = åŒ—äº¬æ—¶é—´ç¬¬äºŒå¤© 2:30
    - cron: '30 6 * * *'   # UTC 6:30 = åŒ—äº¬æ—¶é—´ 14:30
  workflow_dispatch:     # æ— å¼ºåˆ¶é€‰é¡¹ï¼Œæ¯æ¬¡éƒ½å¼ºåˆ¶å…¨æ–°é•œåƒåŒæ­¥

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Delete old meta folder (tolerant)
        run: |
          echo "ğŸ—‘ï¸ å¼ºåˆ¶åˆ é™¤æ—§ meta æ–‡ä»¶å¤¹ï¼ˆå®¹é”™ï¼‰..."
          if [ -d "meta" ]; then
            echo "å‘ç°æ—§ metaï¼Œæ­£åœ¨åˆ é™¤ï¼ˆåŒ…æ‹¬æ‰€æœ‰å¤šä½™æ–‡ä»¶ï¼‰..."
            rm -rf meta
            echo "âœ… æ—§ meta å·²å®Œå…¨åˆ é™¤"
          else
            echo "â„¹ï¸ meta ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
          fi
          
          echo "åˆ é™¤åç¡®è®¤:"
          ls -la | grep meta || echo "meta å·²ä¸å­˜åœ¨"

      - name: Clone source repository
        id: clone_source
        run: |
          SOURCE_DIR="/tmp/meta-source-$(date +%s)"
          echo "source_dir=$SOURCE_DIR" >> $GITHUB_OUTPUT
          
          echo "å…‹éš†æºä»“åº“ meta åˆ†æ”¯ï¼ˆä»…ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼‰..."
          git clone --depth=1 --branch=meta https://github.com/MetaCubeX/meta-rules-dat.git "$SOURCE_DIR"
          
          echo "æºä»“åº“å†…å®¹:"
          ls -la "$SOURCE_DIR/"

      - name: Create and full mirror sync new meta
        run: |
          SOURCE_DIR="${{ steps.clone_source.outputs.source_dir }}"
          
          echo "=== å¼€å§‹å…¨æ–°é•œåƒåŒæ­¥ ==="
          mkdir meta
          
          echo "ä½¿ç”¨ rsync å¼ºåˆ¶é•œåƒï¼ˆ--delete ä¼šåˆ é™¤å¤šä½™æ–‡ä»¶ï¼Œç¡®ä¿å®Œå…¨ä¸€è‡´ï¼‰..."
          rsync -av --delete --exclude='.git' "$SOURCE_DIR/" "meta/"
          
          echo "âœ… æ–° meta å·²é•œåƒå®Œæˆï¼ˆä»… asnã€geo-liteã€geoï¼‰"
          ls -la meta/

      - name: Clean any .dat files
        run: |
          echo "é¢å¤–æ¸…ç† .dat æ–‡ä»¶..."
          if find meta -name "*.dat" -type f 2>/dev/null | grep -q .; then
            find meta -name "*.dat" -type f -delete
            echo "âœ… å·²åˆ é™¤ .dat æ–‡ä»¶"
          else
            echo "âœ“ æ—  .dat æ–‡ä»¶"
          fi

      - name: Commit and push (always, safe even if no changes)
        run: |
          echo "æ·»åŠ å˜åŒ–å¹¶æäº¤æ¨é€..."
          git add meta
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          COMMIT_MSG="ğŸ”„ è‡ªåŠ¨åŒæ­¥: æ›´æ–° MetaCubeX meta æ–‡ä»¶å¤¹
          
          å¼ºåˆ¶åˆ é™¤æ—§ meta å¹¶å…¨æ–°é•œåƒåŒæ­¥ï¼Œç¡®ä¿ä¸æºä»“åº“å®Œå…¨ä¸€è‡´ï¼ˆä»…ä¿ç•™ asnã€geo-liteã€geoï¼‰ã€‚
          å¤šä½™æ–‡ä»¶ï¼ˆå¦‚ listã€mrsã€json ç­‰ï¼‰å·²è¢«è‡ªåŠ¨åˆ é™¤ã€‚
          
          è¯¦ç»†ä¿¡æ¯:
          - æºä»“åº“: MetaCubeX/meta-rules-dat@meta
          - åŒæ­¥æ—¶é—´: $TIMESTAMP
          
          ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ"
          
          git commit -m "$COMMIT_MSG" || echo "æ— å˜åŒ–ï¼Œæ— éœ€ commit"
          git push origin main || echo "æ¨é€å®Œæˆï¼ˆæˆ–æ— å˜åŒ–ï¼‰"
          
          echo "âœ… æ“ä½œå®Œæˆ"

      - name: Cleanup temporary dir
        if: always()
        run: |
          SOURCE_DIR="${{ steps.clone_source.outputs.source_dir }}"
          if [ -n "$SOURCE_DIR" ] && [ -d "$SOURCE_DIR" ]; then
            rm -rf "$SOURCE_DIR"
          fi

      - name: Final verification
        run: |
          echo "=== æœ€ç»ˆéªŒè¯ ==="
          echo "å®Œæˆæ—¶é—´: $(date)"
          
          if [ -d "meta" ]; then
            echo "meta å½“å‰å†…å®¹ï¼ˆåº”ä»…ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼‰:"
            ls -la meta/
            ITEM_COUNT=$(ls -1 meta | wc -l)
            if [ "$ITEM_COUNT" -eq 3 ]; then
              echo "âœ… éªŒè¯æˆåŠŸ: ä»…ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸æºä»“åº“å®Œå…¨ä¸€è‡´"
            else
              echo "âš ï¸  è­¦å‘Š: meta å†…é¡¹ç›®æ•° $ITEM_COUNTï¼ˆå¼‚å¸¸ï¼‰"
            fi
          else
            echo "âŒ é”™è¯¯: meta æœªåˆ›å»º"
          fi
