name: Cleanup Workflow Runs
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old runs
        run: |
          # 获取并删除所有超过3个的运行
          curl -s -H "Authorization: token ${{ secrets.AUTH_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" \
            | jq -r '.workflow_runs | group_by(.workflow_id) | .[] | .[3:] | .[].id' \
            | xargs -I {} curl -X DELETE \
                -H "Authorization: token ${{ secrets.AUTH_PAT }}" \
                "https://api.github.com/repos/${{ github.repository }}/actions/runs/{}"
