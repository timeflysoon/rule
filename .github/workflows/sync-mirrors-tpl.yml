name: Universal Repo Mirror Sync

on:
  schedule:
    # UTCæ—¶é—´ï¼š18:30 å’Œ 06:30ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 02:30 å’Œ 14:30
    - cron: '30 18,6 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œä¸ä¼šåœ¨æ·»åŠ æ–‡ä»¶æ—¶è‡ªåŠ¨è¿è¡Œ
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼ï¼šowner/repo)'
        required: true
        default: 'MetaCubeX/meta-rules-dat'
      target_repo_1:
        description: 'ç›®æ ‡ä»“åº“1åœ°å€ (æ ¼å¼ï¼šowner/repo)'
        required: true
        default: 'timeflysoon/meta-rules-dat'
      target_repo_2:
        description: 'ç›®æ ‡ä»“åº“2åœ°å€ (æ ¼å¼ï¼šowner/repo)'
        required: true
        default: '88alt/meta-rules-dat'

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 1. æ˜¾ç¤ºè¿è¡Œä¿¡æ¯ä¸å‚æ•°
        run: |
          echo "=== é€šç”¨é•œåƒåŒæ­¥ä»»åŠ¡å¯åŠ¨ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘æ—¶é—´ (UTC): $(date '+%Y-%m-%d %H:%M:%S')"
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo ""
          echo "é…ç½®å‚æ•°:"
          echo "  æºä»“åº“ : ${{ github.event.inputs.source_repo }}"
          echo "  ç›®æ ‡ä»“åº“1: ${{ github.event.inputs.target_repo_1 }}"
          echo "  ç›®æ ‡ä»“åº“2: ${{ github.event.inputs.target_repo_2 }}"

      - name: 2. è®¾ç½®SSHå¯†é’¥å¯¹ï¼ˆåŸºäºæ˜ å°„è¡¨ï¼‰
        id: ssh-setup
        run: |
          echo "æ­£åœ¨æ ¹æ®é¢„å®šä¹‰æ˜ å°„è¡¨é…ç½®SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # å®šä¹‰å†…éƒ¨æ˜ å°„è¡¨ (Owner -> [Hoståˆ«å, ç§é’¥æ–‡ä»¶å, GitHub Secretå])
          declare -A SSH_MAP
          SSH_MAP[timeflysoon]="github-timeflysoon id_ed25519_timeflysoon SSH_PRIVATE_KEY_TIMEFLYSOON"
          SSH_MAP[88alt]="github-88alt id_ed25519_88alt SSH_PRIVATE_KEY_88ALT"
          SSH_MAP[88top]="github-88top id_ed25519_88top SSH_PRIVATE_KEY_88TOP"
          SSH_MAP[88sys]="github-88sys id_ed25519_88sys SSH_PRIVATE_KEY_88SYS"
          
          # æå–è¾“å…¥çš„ç›®æ ‡ä»“åº“æ‰€æœ‰è€…
          OWNER_1=$(echo "${{ github.event.inputs.target_repo_1 }}" | cut -d'/' -f1)
          OWNER_2=$(echo "${{ github.event.inputs.target_repo_2 }}" | cut -d'/' -f1)
          
          # æŸ¥æ‰¾å¹¶åº”ç”¨é…ç½®
          get_ssh_config() {
            local owner=$1
            local config="${SSH_MAP[$owner]}"
            if [ -z "$config" ]; then
              echo "âŒ é”™è¯¯ï¼šæœªé¢„é…ç½®çš„ä»“åº“æ‰€æœ‰è€… '$owner'ã€‚"
              echo "   å…è®¸çš„é…ç½®æœ‰ï¼štimeflysoon, 88alt, 88top, 88sys"
              exit 1
            fi
            echo "$config"
          }
          
          echo "æ­£åœ¨ä¸ºè¾“å…¥çš„ç›®æ ‡ä»“åº“åŠ è½½æ˜ å°„..."
          CONFIG_1=$(get_ssh_config "$OWNER_1")
          CONFIG_2=$(get_ssh_config "$OWNER_2")
          
          read HOST_1 KEY_1 SECRET_1 <<< "$CONFIG_1"
          read HOST_2 KEY_2 SECRET_2 <<< "$CONFIG_2"
          
          # åŠ¨æ€å†™å…¥ç§é’¥æ–‡ä»¶ - ç›´æ¥ä½¿ç”¨ç¡¬ç¼–ç çš„Secretåç§°
          echo "æ­£åœ¨å†™å…¥ç§é’¥æ–‡ä»¶..."
          
          # æ ¹æ®ä¸åŒçš„SECRET_1å€¼é€‰æ‹©å¯¹åº”çš„GitHub Secret
          case "$SECRET_1" in
            SSH_PRIVATE_KEY_TIMEFLYSOON)
              echo "${{ secrets.SSH_PRIVATE_KEY_TIMEFLYSOON }}" > ~/.ssh/$KEY_1
              ;;
            SSH_PRIVATE_KEY_88ALT)
              echo "${{ secrets.SSH_PRIVATE_KEY_88ALT }}" > ~/.ssh/$KEY_1
              ;;
            SSH_PRIVATE_KEY_88TOP)
              echo "${{ secrets.SSH_PRIVATE_KEY_88TOP }}" > ~/.ssh/$KEY_1
              ;;
            SSH_PRIVATE_KEY_88SYS)
              echo "${{ secrets.SSH_PRIVATE_KEY_88SYS }}" > ~/.ssh/$KEY_1
              ;;
            *)
              echo "âŒ é”™è¯¯ï¼šæœªçŸ¥çš„Secretåç§° '$SECRET_1'"
              exit 1
              ;;
          esac
          
          # æ ¹æ®ä¸åŒçš„SECRET_2å€¼é€‰æ‹©å¯¹åº”çš„GitHub Secret
          case "$SECRET_2" in
            SSH_PRIVATE_KEY_TIMEFLYSOON)
              echo "${{ secrets.SSH_PRIVATE_KEY_TIMEFLYSOON }}" > ~/.ssh/$KEY_2
              ;;
            SSH_PRIVATE_KEY_88ALT)
              echo "${{ secrets.SSH_PRIVATE_KEY_88ALT }}" > ~/.ssh/$KEY_2
              ;;
            SSH_PRIVATE_KEY_88TOP)
              echo "${{ secrets.SSH_PRIVATE_KEY_88TOP }}" > ~/.ssh/$KEY_2
              ;;
            SSH_PRIVATE_KEY_88SYS)
              echo "${{ secrets.SSH_PRIVATE_KEY_88SYS }}" > ~/.ssh/$KEY_2
              ;;
            *)
              echo "âŒ é”™è¯¯ï¼šæœªçŸ¥çš„Secretåç§° '$SECRET_2'"
              exit 1
              ;;
          esac
          
          chmod 600 ~/.ssh/$KEY_1 ~/.ssh/$KEY_2
          
          # åŠ¨æ€ç”Ÿæˆ SSH Config
          cat > ~/.ssh/config << EOF
          # ç›®æ ‡ä»“åº“1 ($OWNER_1) | Deploy Keyæ ‡é¢˜: github-actions-sync-${OWNER_1}
          Host $HOST_1
            HostName github.com
            User git
            IdentityFile ~/.ssh/$KEY_1
            IdentitiesOnly yes
            StrictHostKeyChecking no
          
          # ç›®æ ‡ä»“åº“2 ($OWNER_2) | Deploy Keyæ ‡é¢˜: github-actions-sync-${OWNER_2}
          Host $HOST_2
            HostName github.com
            User git
            IdentityFile ~/.ssh/$KEY_2
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF
          
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          
          # å°†å…³é”®çš„æ˜ å°„ç»“æœè¾“å‡ºåˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "HOST_1=$HOST_1" >> $GITHUB_ENV
          echo "HOST_2=$HOST_2" >> $GITHUB_ENV
          
          echo "âœ… SSHé…ç½®å®Œæˆ"
          echo "æ˜ å°„è¯¦æƒ…ï¼š"
          echo "  $OWNER_1 -> Host: $HOST_1, Key: $KEY_1, Secret: $SECRET_1"
          echo "  $OWNER_2 -> Host: $HOST_2, Key: $KEY_2, Secret: $SECRET_2"

      - name: 3. éªŒè¯SSHè¿æ¥
        run: |
          echo "éªŒè¯SSHè¿æ¥..."
          echo "ä½¿ç”¨æ˜ å°„çš„Hoståˆ«åè¿›è¡Œè¿æ¥æµ‹è¯•..."
          
          # ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–Hoståˆ«å
          HOST_1="${{ env.HOST_1 }}"
          HOST_2="${{ env.HOST_2 }}"
          
          for HOST in $HOST_1 $HOST_2; do
            echo "æµ‹è¯•è¿æ¥ $HOST ..."
            if ssh -T git@$HOST 2>&1 | grep -q "successfully authenticated"; then
              echo "  âœ… è¿æ¥æˆåŠŸ"
            else
              echo "  âŒ è¿æ¥å¤±è´¥"
              exit 1
            fi
          done
          echo "æ‰€æœ‰SSHè¿æ¥éªŒè¯é€šè¿‡"

      - name: 4. é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global core.sshCommand "ssh -F ~/.ssh/config"
          git config --global init.defaultBranch main
          echo "âœ… Gité…ç½®å®Œæˆ"

      - name: 5. å…‹éš†æºä»“åº“
        run: |
          echo "æ­£åœ¨å…‹éš†æºä»“åº“..."
          
          SOURCE_REPO="https://github.com/${{ github.event.inputs.source_repo }}.git"
          echo "æºä»“åº“URL: $SOURCE_REPO"
          
          CLONE_START=$(date +%s)
          
          MAX_RETRY=3
          for i in $(seq 1 $MAX_RETRY); do
            echo "å…‹éš†å°è¯• $i/$MAX_RETRY..."
            
            rm -rf source-repo.git 2>/dev/null || true
            
            if git clone --mirror "$SOURCE_REPO" source-repo.git; then
              CLONE_END=$(date +%s)
              CLONE_DURATION=$((CLONE_END - CLONE_START))
              echo "âœ… å…‹éš†æˆåŠŸï¼Œè€—æ—¶: ${CLONE_DURATION}ç§’"
              break
            elif [ $i -eq $MAX_RETRY ]; then
              echo "âŒ å…‹éš†å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
              exit 1
            else
              echo "å…‹éš†å¤±è´¥ï¼Œ10ç§’åé‡è¯• ($i/$MAX_RETRY)..."
              sleep 10
            fi
          done
          
          cd source-repo.git
          
          echo "åº”ç”¨Gité…ç½®è§„åˆ™..."
          git config --unset-all remote.origin.fetch 2>/dev/null || true
          git config --add remote.origin.fetch '+refs/heads/*:refs/heads/*'
          git config --add remote.origin.fetch '+refs/tags/*:refs/tags/*'
          
          {
              git for-each-ref --format='delete %(refname)' refs/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— æœ¬åœ°PRå¼•ç”¨å¯æ¸…ç†"
          
          {
              git for-each-ref --format='delete %(refname)' refs/remotes/origin/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— è¿œç¨‹PRå¼•ç”¨å¯æ¸…ç†"
          
          echo "è·å–æœ€æ–°æ›´æ–°..."
          git fetch --prune origin
          
          echo "ä»“åº“ä¿¡æ¯:"
          echo "  åˆ†æ”¯: $(git branch -r | wc -l)"
          echo "  æ ‡ç­¾: $(git tag | wc -l)"
          echo "  å¤§å°: $(du -sh . | cut -f1)"
          
          cd ..

      - name: 6. æ‰§è¡Œé•œåƒåŒæ­¥
        run: |
          set -e
          cd source-repo.git
          echo "=== å¼€å§‹åŒæ­¥é•œåƒä»“åº“ $(date '+%Y-%m-%d %H:%M:%S') UTC ==="
          
          # ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–Hoståˆ«å
          HOST_1="${{ env.HOST_1 }}"
          HOST_2="${{ env.HOST_2 }}"
          
          TARGET_REPOS=(
            "git@$HOST_1:${{ github.event.inputs.target_repo_1 }}.git"
            "git@$HOST_2:${{ github.event.inputs.target_repo_2 }}.git"
          )
          
          SYNC_START=$(date +%s)
          for TARGET_REPO in "${TARGET_REPOS[@]}"; do
            REPO_PATH=$(echo "$TARGET_REPO" | cut -d':' -f2)
            echo ">> æ¨é€é•œåƒåˆ°: $REPO_PATH"
            REPO_START=$(date +%s)
            
            MAX_RETRY=2
            for i in $(seq 1 $MAX_RETRY); do
              echo "  å°è¯• $i/$MAX_RETRY..."
              if git push --mirror "$TARGET_REPO"; then
                REPO_DURATION=$(( $(date +%s) - $REPO_START ))
                BRANCHES_COUNT=$(git branch -r | wc -l)
                TAGS_COUNT=$(git tag | wc -l)
                echo "  âœ… æ¨é€æˆåŠŸ (åˆ†æ”¯: $BRANCHES_COUNT, æ ‡ç­¾: $TAGS_COUNT, è€—æ—¶: ${REPO_DURATION}ç§’)"
                break
              elif [ $i -eq $MAX_RETRY ]; then
                echo "  âŒ æ¨é€å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
                break
              else
                sleep 10
              fi
            done
          done
          
          TOTAL_DURATION=$(( $(date +%s) - $SYNC_START ))
          echo "=== åŒæ­¥å®Œæˆï¼Œæ€»è€—æ—¶: ${TOTAL_DURATION}ç§’ ==="

      - name: 7. æ¸…ç†æ•æ„Ÿæ•°æ®
        if: always()
        run: |
          echo "æ¸…ç†SSHå¯†é’¥æ–‡ä»¶..."
          TARGET_1_OWNER=$(echo "${{ github.event.inputs.target_repo_1 }}" | cut -d'/' -f1)
          TARGET_2_OWNER=$(echo "${{ github.event.inputs.target_repo_2 }}" | cut -d'/' -f1)
          
          # æ ¹æ®æ˜ å°„è¡¨æ¸…ç†å¯¹åº”çš„ç§é’¥æ–‡ä»¶
          declare -A SSH_MAP
          SSH_MAP[timeflysoon]="id_ed25519_timeflysoon"
          SSH_MAP[88alt]="id_ed25519_88alt"
          SSH_MAP[88top]="id_ed25519_88top"
          SSH_MAP[88sys]="id_ed25519_88sys"
          
          KEY_1="${SSH_MAP[$TARGET_1_OWNER]}"
          KEY_2="${SSH_MAP[$TARGET_2_OWNER]}"
          
          rm -f ~/.ssh/$KEY_1 ~/.ssh/$KEY_2 2>/dev/null || true
          rm -f ~/.ssh/config ~/.ssh/known_hosts 2>/dev/null || true
          echo "âœ… æ•æ„Ÿæ•°æ®æ¸…ç†å®Œæˆ"

      - name: 8. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸš€ é€šç”¨é•œåƒåŒæ­¥ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**è¿è¡Œä¿¡æ¯**:" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡ŒçŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡ŒID: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**åŒæ­¥é…ç½®**:" >> $GITHUB_STEP_SUMMARY
          echo "- æºä»“åº“: [${{ github.event.inputs.source_repo }}](https://github.com/${{ github.event.inputs.source_repo }})" >> $GITHUB_STEP_SUMMARY
          echo "- ç›®æ ‡ä»“åº“1: [${{ github.event.inputs.target_repo_1 }}](https://github.com/${{ github.event.inputs.target_repo_1 }})" >> $GITHUB_STEP_SUMMARY
          echo "- ç›®æ ‡ä»“åº“2: [${{ github.event.inputs.target_repo_2 }}](https://github.com/${{ github.event.inputs.target_repo_2 }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **æ‰§è¡Œç»“æœ**: åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰ç›®æ ‡ä»“åº“å‡å·²åŒæ­¥æœ€æ–°å†…å®¹ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ‰§è¡Œç»“æœ**: åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—æ’æŸ¥é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
