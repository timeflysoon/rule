name: Sync Multiple Repositories

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 03:00 å’Œ 15:00 è‡ªåŠ¨è¿è¡Œï¼Œé»˜è®¤åŒæ­¥æ‰€æœ‰forkä»“åº“
    - cron: '0 19 * * *'  # UTC 19:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 03:00
    - cron: '0 7 * * *'   # UTC 07:00 = åŒ—äº¬æ—¶é—´å½“å¤© 15:00
  workflow_dispatch:
    inputs:
      repositories:
        description: |
          è¦åŒæ­¥çš„ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰
          ç•™ç©ºï¼šä»…åŒæ­¥å½“å‰ä»“åº“
          è¾“å…¥ 'all'ï¼šåŒæ­¥æ‰€æœ‰forkä»“åº“
          é»˜è®¤ï¼šç©ºï¼ˆä»…å½“å‰ä»“åº“ï¼‰
        required: false
        default: ""

permissions:
  contents: write

jobs:
  sync-repositories:
    runs-on: ubuntu-latest
    
    steps:
    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: ç¡®å®šåŒæ­¥æ¨¡å¼
      id: determine-mode
      run: |
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "schedule" ]; then
          # å®šæ—¶ä»»åŠ¡ï¼šé»˜è®¤åŒæ­¥æ‰€æœ‰forkä»“åº“
          echo "ğŸ• å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä½¿ç”¨ 'all' æ¨¡å¼"
          echo "mode=all" >> $GITHUB_OUTPUT
          echo "repositories_input=all" >> $GITHUB_OUTPUT
        else
          # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨ç”¨æˆ·è¾“å…¥
          USER_INPUT="${{ github.event.inputs.repositories }}"
          echo "ğŸ‘† æ‰‹åŠ¨è§¦å‘ï¼Œç”¨æˆ·è¾“å…¥: '$USER_INPUT'"
          
          if [ -z "$USER_INPUT" ]; then
            echo "ç”¨æˆ·è¾“å…¥ä¸ºç©ºï¼ŒåŒæ­¥å½“å‰ä»“åº“"
            echo "mode=current" >> $GITHUB_OUTPUT
            echo "repositories_input=${{ github.repository }}" >> $GITHUB_OUTPUT
          elif [ "$USER_INPUT" = "all" ]; then
            echo "ç”¨æˆ·è¾“å…¥ 'all'ï¼ŒåŒæ­¥æ‰€æœ‰forkä»“åº“"
            echo "mode=all" >> $GITHUB_OUTPUT
            echo "repositories_input=all" >> $GITHUB_OUTPUT
          else
            echo "ç”¨æˆ·æŒ‡å®šä»“åº“: $USER_INPUT"
            echo "mode=manual" >> $GITHUB_OUTPUT
            echo "repositories_input=$USER_INPUT" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: è·å–æ‰€æœ‰forkä»“åº“åˆ—è¡¨ï¼ˆå¦‚æœæ˜¯allæ¨¡å¼ï¼‰
      if: steps.determine-mode.outputs.mode == 'all'
      id: get-all-fork-repos
      env:
        GH_TOKEN: ${{ secrets.AUTH_PAT }}
      run: |
        echo "ğŸ” æ­£åœ¨è·å–æ‚¨æ‰€æœ‰çš„forkä»“åº“..."
        
        page=1
        ALL_FORK_REPOS=""
        
        while true; do
          RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
                        "https://api.github.com/user/repos?per_page=100&page=$page&affiliation=owner&sort=full_name")
          
          # æå–forkä»“åº“
          FORK_REPOS=$(echo "$RESPONSE" | jq -r '.[] | select(.fork == true) | .full_name' | tr '\n' ',')
          
          if [ -z "$FORK_REPOS" ] || [ "$FORK_REPOS" = "" ]; then
            break
          fi
          
          ALL_FORK_REPOS="${ALL_FORK_REPOS}${FORK_REPOS}"
          page=$((page + 1))
          
          echo "ğŸ“Š å·²è·å– $(( (page-1) * 100 )) ä¸ªä»“åº“..."
          
          if [ $page -gt 10 ]; then
            echo "âš ï¸ å·²è·å– 1000 ä¸ªä»“åº“ï¼Œå¦‚éœ€æ›´å¤šè¯·è°ƒæ•´é™åˆ¶"
            break
          fi
          
          sleep 0.5
        done
        
        ALL_FORK_REPOS=${ALL_FORK_REPOS%,}
        REPO_COUNT=$(echo "$ALL_FORK_REPOS" | tr ',' '\n' | wc -l)
        
        echo "fork_repositories=$ALL_FORK_REPOS" >> $GITHUB_OUTPUT
        echo "âœ… å…±æ‰¾åˆ° $REPO_COUNT ä¸ªforkä»“åº“"
        
    - name: å‡†å¤‡ä»“åº“åˆ—è¡¨
      id: prepare-repos
      run: |
        MODE="${{ steps.determine-mode.outputs.mode }}"
        REPOS_INPUT="${{ steps.determine-mode.outputs.repositories_input }}"
        
        echo "å‡†å¤‡æ¨¡å¼: $MODE"
        echo "è¾“å…¥: $REPOS_INPUT"
        
        if [ "$MODE" = "all" ]; then
          # ä½¿ç”¨æ‰€æœ‰forkä»“åº“
          FINAL_REPOS="${{ steps.get-all-fork-repos.outputs.fork_repositories }}"
          echo "ğŸš€ å°†åŒæ­¥æ‰€æœ‰forkä»“åº“ ($FINAL_REPOS)"
        elif [ "$MODE" = "current" ]; then
          # ä»…å½“å‰ä»“åº“
          FINAL_REPOS="$REPOS_INPUT"
          echo "ğŸ“ å°†åŒæ­¥å½“å‰ä»“åº“: $FINAL_REPOS"
        else
          # æ‰‹åŠ¨æŒ‡å®šçš„ä»“åº“
          FINAL_REPOS="$REPOS_INPUT"
          echo "ğŸ¯ å°†åŒæ­¥æŒ‡å®šä»“åº“: $FINAL_REPOS"
        fi
        
        # æ¸…ç†æ ¼å¼
        FINAL_REPOS=$(echo "$FINAL_REPOS" | tr -d ' ' | sed 's/,,*/,/g' | sed 's/^,//' | sed 's/,$//')
        
        echo "repositories=$FINAL_REPOS" >> $GITHUB_OUTPUT
        
    - name: åŒæ­¥ä»“åº“
      env:
        REPOSITORIES: ${{ steps.prepare-repos.outputs.repositories }}
        GH_TOKEN: ${{ secrets.AUTH_PAT }}
      run: |
        echo "ğŸš€ å¼€å§‹åŒæ­¥ä»“åº“..."
        echo "ä»“åº“åˆ—è¡¨: $REPOSITORIES"
        
        if [ -z "$REPOSITORIES" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šè¦åŒæ­¥çš„ä»“åº“"
          exit 1
        fi
        
        IFS=',' read -ra REPO_ARRAY <<< "$REPOSITORIES"
        
        SYNC_SUCCESS=0
        SYNC_SKIP=0
        SYNC_FAILED=0
        
        for FORK_REPO in "${REPO_ARRAY[@]}"; do
          echo ""
          echo "========================================"
          echo "ğŸ”„ åŒæ­¥ä»“åº“ ($((SYNC_SUCCESS + SYNC_SKIP + SYNC_FAILED + 1))/${#REPO_ARRAY[@]}): $FORK_REPO"
          echo "========================================"
          
          # 1. è·å–forkä»“åº“çš„ä¸Šæ¸¸ä¿¡æ¯
          echo "ğŸ“¡ è·å–ä»“åº“ä¿¡æ¯..."
          REPO_INFO=$(curl -s -H "Authorization: token $GH_TOKEN" \
                      "https://api.github.com/repos/$FORK_REPO")
          
          PARENT_REPO=$(echo "$REPO_INFO" | jq -r '.parent.full_name // empty')
          
          if [ -z "$PARENT_REPO" ] || [ "$PARENT_REPO" = "null" ]; then
            echo "âš ï¸  $FORK_REPO ä¸æ˜¯forkä»“åº“æˆ–æ— æ³•è·å–ä¸Šæ¸¸ï¼Œè·³è¿‡"
            SYNC_SKIP=$((SYNC_SKIP + 1))
            continue
          fi
          
          echo "âœ… ä¸Šæ¸¸ä»“åº“: $PARENT_REPO"
          
          # 2. åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # 3. å…‹éš†forkä»“åº“ï¼ˆä½¿ç”¨PATï¼‰
          echo "ğŸ“¥ å…‹éš†forkä»“åº“..."
          if ! git clone "https://x-access-token:$GH_TOKEN@github.com/$FORK_REPO.git" . 2>/dev/null; then
            echo "âŒ å…‹éš†ä»“åº“å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰æƒé™"
            cd /
            rm -rf "$TEMP_DIR"
            SYNC_FAILED=$((SYNC_FAILED + 1))
            continue
          fi
          
          # 4. è®¾ç½®Gitç”¨æˆ·
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 5. æ·»åŠ ä¸Šæ¸¸è¿œç¨‹
          echo "ğŸ”— æ·»åŠ ä¸Šæ¸¸ä»“åº“..."
          git remote add upstream "https://github.com/$PARENT_REPO.git"
          
          # 6. è·å–æ‰€æœ‰ä¸Šæ¸¸åˆ†æ”¯
          echo "ğŸ“¡ è·å–ä¸Šæ¸¸åˆ†æ”¯..."
          if ! git fetch upstream 2>/dev/null; then
            echo "âŒ è·å–ä¸Šæ¸¸åˆ†æ”¯å¤±è´¥ï¼Œå¯èƒ½ä¸Šæ¸¸ä»“åº“ä¸å­˜åœ¨"
            cd /
            rm -rf "$TEMP_DIR"
            SYNC_FAILED=$((SYNC_FAILED + 1))
            continue
          fi
          
          # 7. è·å–æ‰€æœ‰åˆ†æ”¯
          BRANCHES=$(git branch -r | grep 'upstream/' | sed 's/upstream\///' | grep -v HEAD)
          
          if [ -z "$BRANCHES" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°åˆ†æ”¯ï¼Œè·³è¿‡"
            cd /
            rm -rf "$TEMP_DIR"
            SYNC_SKIP=$((SYNC_SKIP + 1))
            continue
          fi
          
          echo "ğŸŒ¿ æ‰¾åˆ°åˆ†æ”¯: $BRANCHES"
          
          # 8. ä¿å­˜å½“å‰åˆ†æ”¯
          ORIG_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
          
          # 9. åŒæ­¥æ¯ä¸ªåˆ†æ”¯
          for BRANCH in $BRANCHES; do
            BRANCH=$(echo "$BRANCH" | xargs)
            [ -z "$BRANCH" ] && continue
            
            echo "  å¤„ç†åˆ†æ”¯: $BRANCH"
            
            # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
            if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
              git checkout "$BRANCH"
              echo "  æ‹‰å–ä¸Šæ¸¸æ›´æ–°..."
              if ! git pull upstream "$BRANCH" --no-rebase 2>/dev/null; then
                echo "  âš ï¸ æ‹‰å–å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶åŒæ­¥"
                git reset --hard "upstream/$BRANCH"
              fi
            else
              git checkout -b "$BRANCH" "upstream/$BRANCH"
            fi
            
            # æ¨é€åˆ°forkä»“åº“
            echo "  æ¨é€åˆ° $FORK_REPO..."
            if ! git push origin "$BRANCH" 2>/dev/null; then
              echo "  âŒ æ¨é€å¤±è´¥"
            else
              echo "  âœ… æ¨é€æˆåŠŸ"
            fi
          done
          
          # 10. æ¸…ç†
          cd /
          rm -rf "$TEMP_DIR"
          
          echo "âœ… $FORK_REPO åŒæ­¥å®Œæˆ"
          SYNC_SUCCESS=$((SYNC_SUCCESS + 1))
        done
        
        echo ""
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "ğŸ“Š ç»Ÿè®¡ï¼š"
        echo "  âœ… æˆåŠŸ: $SYNC_SUCCESS"
        echo "  â­ï¸ è·³è¿‡: $SYNC_SKIP"
        echo "  âŒ å¤±è´¥: $SYNC_FAILED"
        
    - name: ç”ŸæˆæŠ¥å‘Š
      if: always()
      env:
        MODE: ${{ steps.determine-mode.outputs.mode }}
        SYNC_COUNT: ${{ fromJSON(steps.prepare-repos.outputs.repositories != '' && '[' + steps.prepare-repos.outputs.repositories + ']' || '[]') && length(fromJSON('[' + steps.prepare-repos.outputs.repositories + ']')) || 0 }}
      run: |
        echo "## ğŸ“Š ä»“åº“åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**åŒæ­¥æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**åŒæ­¥æ¨¡å¼:** $MODE" >> $GITHUB_STEP_SUMMARY
        echo "**ç›®æ ‡ä»“åº“æ•°:** $SYNC_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if ${{ job.status == 'success' }}; then
          echo "**çŠ¶æ€:** âœ… åŒæ­¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ä¸‹ä¸€æ¬¡å®šæ—¶åŒæ­¥æ—¶é—´ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "> - åŒ—äº¬æ—¶é—´ 03:00ï¼ˆUTC å‰ä¸€å¤© 19:00ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "> - åŒ—äº¬æ—¶é—´ 15:00ï¼ˆUTC å½“å¤© 07:00ï¼‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "**çŠ¶æ€:** âš ï¸ åŒæ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
