name: Sync Fork from Upstream

on:
  schedule:
    - cron: '0 19 * * *'  # UTC 19:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 03:00
    - cron: '0 7 * * *'   # UTC 07:00 = åŒ—äº¬æ—¶é—´å½“å¤© 15:00
  workflow_dispatch:
    inputs:
      upstream_repos:
        description: 'ä¸Šæ¸¸ä»“åº“ (æ ¼å¼: owner/repo)'
        required: false
        default: 'all'

permissions:
  contents: write

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
    - name: Configure Git credentials
      run: |
        # è®¾ç½® Git å‡­è¯å­˜å‚¨
        git config --global credential.helper store
        echo "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials
        
    - name: Setup upstream
      id: setup-upstream
      run: |
        echo "è®¾ç½®ä¸Šæ¸¸ä»“åº“..."
        
        # è®¾ç½®é»˜è®¤ä¸Šæ¸¸ä¸º vernesong/OpenClash
        UPSTREAM_REPO="vernesong/OpenClash"
        echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
        echo "ä½¿ç”¨ä¸Šæ¸¸: $UPSTREAM_REPO"
        
    - name: Sync all branches
      env:
        UPSTREAM_REPO: ${{ steps.setup-upstream.outputs.upstream_repo }}
      run: |
        echo "å¼€å§‹åŒæ­¥ä¸Šæ¸¸ä»“åº“: $UPSTREAM_REPO"
        
        # æ·»åŠ æˆ–æ›´æ–°ä¸Šæ¸¸è¿œç¨‹
        git remote add upstream "https://github.com/$UPSTREAM_REPO.git" 2>/dev/null || \
          git remote set-url upstream "https://github.com/$UPSTREAM_REPO.git"
        
        # æ˜¾ç¤ºè¿œç¨‹ä¿¡æ¯
        echo "å½“å‰è¿œç¨‹ä»“åº“:"
        git remote -v
        
        # èŽ·å–ä¸Šæ¸¸æ‰€æœ‰åˆ†æ”¯
        echo "èŽ·å–ä¸Šæ¸¸åˆ†æ”¯..."
        git fetch upstream --prune
        
        # èŽ·å–æ‰€æœ‰åˆ†æ”¯åˆ—è¡¨
        echo "ä¸Šæ¸¸åˆ†æ”¯åˆ—è¡¨:"
        git branch -r
        
        # èŽ·å–ä¸Šæ¸¸åˆ†æ”¯ï¼ˆæŽ’é™¤HEADï¼‰
        UPSTREAM_BRANCHES=$(git branch -r | grep 'upstream/' | grep -v HEAD)
        echo "æ‰¾åˆ°çš„åˆ†æ”¯: $UPSTREAM_BRANCHES"
        
        # å¦‚æžœæ²¡æœ‰åˆ†æ”¯ï¼Œé€€å‡º
        if [ -z "$UPSTREAM_BRANCHES" ]; then
          echo "æ²¡æœ‰æ‰¾åˆ°ä¸Šæ¸¸åˆ†æ”¯"
          exit 0
        fi
        
        # åŒæ­¥æ¯ä¸ªåˆ†æ”¯
        for BRANCH in $UPSTREAM_BRANCHES; do
          # æ¸…ç†åˆ†æ”¯å
          BRANCH_NAME=$(echo "$BRANCH" | sed 's/upstream\///' | xargs)
          
          if [ -z "$BRANCH_NAME" ]; then
            continue
          fi
          
          echo "å¤„ç†åˆ†æ”¯: $BRANCH_NAME"
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨è¯¥åˆ†æ”¯
          if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
            echo "åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ° $BRANCH_NAME"
            git checkout "$BRANCH_NAME"
            
            # æ‹‰å–ä¸Šæ¸¸æ›´æ–°
            echo "æ‹‰å–ä¸Šæ¸¸æ›´æ–°..."
            git pull upstream "$BRANCH_NAME" --no-rebase
          else
            echo "åˆ›å»ºæ–°åˆ†æ”¯: $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME" "upstream/$BRANCH_NAME"
          fi
          
          # æŽ¨é€æ›´æ–°
          echo "æŽ¨é€åˆ° origin..."
          git push origin "$BRANCH_NAME"
          
          echo "âœ… åˆ†æ”¯ $BRANCH_NAME åŒæ­¥å®Œæˆ"
        done
        
        echo "ðŸŽ‰ æ‰€æœ‰åˆ†æ”¯åŒæ­¥å®Œæˆ"
        
    - name: Create summary
      if: always()
      run: |
        echo "## ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ä»“åº“:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**ä¸Šæ¸¸:** vernesong/OpenClash" >> $GITHUB_STEP_SUMMARY
        echo "**åŒæ­¥æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**çŠ¶æ€:** âœ… åŒæ­¥ä»»åŠ¡å·²æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
