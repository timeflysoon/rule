name: Sync Mirror Repositories

# åªä¿ç•™æ‰‹åŠ¨è§¦å‘å’Œå®šæ—¶ä»»åŠ¡ï¼Œç§»é™¤pushè§¦å‘
on:
  schedule:
    - cron: '30 2,14 * * *'  # UTCæ—¶é—´ï¼š02:30å’Œ14:30ï¼ˆåŒ—äº¬æ—¶é—´10:30å’Œ22:30ï¼‰
  workflow_dispatch:          # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆä¸ä¼šåœ¨æ·»åŠ æ–‡ä»¶æ—¶è‡ªåŠ¨è¿è¡Œï¼‰
    inputs:
      source_repo:
        description: 'æºä»“åº“URL (å¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤)'
        required: false
        default: 'https://github.com/metacubex/meta-rules-dat.git'
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ (å³ä½¿æ²¡æœ‰æ›´æ–°ä¹Ÿæ‰§è¡Œ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 1. éªŒè¯è§¦å‘æ¡ä»¶
        run: |
          echo "=== é•œåƒåŒæ­¥ä»»åŠ¡å¯åŠ¨ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘å‚æ•°:"
            echo "  - æºä»“åº“: ${{ github.event.inputs.source_repo }}"
            echo "  - å¼ºåˆ¶åŒæ­¥: ${{ github.event.inputs.force_sync }}"
          fi

      - name: 2. è®¾ç½®SSHå¯†é’¥å¯¹
        run: |
          echo "é…ç½®SSHçŽ¯å¢ƒ..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # å†™å…¥ä¸¤ä¸ªç‹¬ç«‹çš„ç§é’¥
          echo "${{ secrets.SSH_PRIVATE_KEY_T }}" > ~/.ssh/id_ed25519_t
          echo "${{ secrets.SSH_PRIVATE_KEY_X1 }}" > ~/.ssh/id_ed25519_x1
          chmod 600 ~/.ssh/id_ed25519_t ~/.ssh/id_ed25519_x1
          
          # é…ç½®SSHä¸»æœºåˆ«å
          cat > ~/.ssh/config << 'EOF'
          # timeflysoonä»“åº“ä¸“ç”¨é…ç½®
          Host github-t
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_t
            IdentitiesOnly yes
            StrictHostKeyChecking no
            ConnectTimeout 10
          
          # 88altä»“åº“ä¸“ç”¨é…ç½®
          Host github-x1
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_x1
            IdentitiesOnly yes
            StrictHostKeyChecking no
            ConnectTimeout 10
          EOF
          
          # æ·»åŠ GitHubä¸»æœºæŒ‡çº¹
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "âœ… SSHé…ç½®å®Œæˆ"
          echo "ç§é’¥æ–‡ä»¶åˆ—è¡¨:"
          ls -la ~/.ssh/id_ed25519_*

      - name: 3. éªŒè¯SSHè¿žæŽ¥
        run: |
          echo "=== éªŒè¯SSHå¯†é’¥è¿žæŽ¥ ==="
          
          # æµ‹è¯•ç¬¬ä¸€ä¸ªå¯†é’¥
          echo "æµ‹è¯• timeflysoon ä»“åº“è¿žæŽ¥..."
          if ssh -T git@github-t 2>&1 | grep -q "timeflysoon"; then
            echo "âœ… å¯†é’¥Tè¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥Tè¿žæŽ¥å¤±è´¥"
            ssh -T git@github-t
            exit 1
          fi
          
          # æµ‹è¯•ç¬¬äºŒä¸ªå¯†é’¥
          echo "æµ‹è¯• 88alt ä»“åº“è¿žæŽ¥..."
          if ssh -T git@github-x1 2>&1 | grep -q "88alt"; then
            echo "âœ… å¯†é’¥X1è¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥X1è¿žæŽ¥å¤±è´¥"
            ssh -T git@github-x1
            exit 1
          fi
          
          echo "=== æ‰€æœ‰SSHè¿žæŽ¥éªŒè¯é€šè¿‡ ==="

      - name: 4. é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global core.sshCommand "ssh -F ~/.ssh/config"
          git config --global init.defaultBranch main
          git config --global pull.rebase false
          git config --global advice.detachedHead false
          
          echo "âœ… Gité…ç½®å®Œæˆ"

      - name: 5. ç¡®å®šæºä»“åº“URL
        id: source-repo
        run: |
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æœ‰è¾“å…¥å‚æ•°ï¼Œä½¿ç”¨è¾“å…¥å‚æ•°
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.source_repo }}" != "" ]]; then
            SOURCE_REPO="${{ github.event.inputs.source_repo }}"
            echo "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„æºä»“åº“: $SOURCE_REPO"
          else
            # âš ï¸ è¿™é‡Œè®¾ç½®ä½ çš„é»˜è®¤æºä»“åº“URL
            SOURCE_REPO="https://github.com/metacubex/meta-rules-dat.git"
            echo "ä½¿ç”¨é»˜è®¤æºä»“åº“: $SOURCE_REPO"
          fi
          
          echo "source_repo=$SOURCE_REPO" >> $GITHUB_ENV
          echo "::notice::æºä»“åº“URL: $SOURCE_REPO"

      - name: 6. å…‹éš†æºä»“åº“
        run: |
          echo "æ­£åœ¨å…‹éš†æºä»“åº“..."
          rm -rf meta-rules-dat.git 2>/dev/null || true
          
          echo "æºä»“åº“URL: $source_repo"
          
          # å…‹éš†ä»“åº“ï¼ˆè®¾ç½®é‡è¯•æœºåˆ¶ï¼‰
          MAX_RETRY=3
          for i in $(seq 1 $MAX_RETRY); do
            echo "å…‹éš†å°è¯• $i/$MAX_RETRY..."
            if git clone --mirror "$source_repo" meta-rules-dat.git; then
              echo "âœ… å…‹éš†æˆåŠŸ"
              break
            elif [ $i -eq $MAX_RETRY ]; then
              echo "âŒ å…‹éš†å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
              echo "é”™è¯¯: æ— æ³•å…‹éš†æºä»“åº“ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®"
              echo "URL: $source_repo"
              exit 1
            else
              echo "å…‹éš†å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
              sleep 10
            fi
          done
          
          cd meta-rules-dat.git
          echo "ä»“åº“ä¿¡æ¯:"
          echo "  åˆ†æ”¯æ•°é‡: $(git branch -r | wc -l 2>/dev/null || echo '0')"
          echo "  æ ‡ç­¾æ•°é‡: $(git tag | wc -l 2>/dev/null || echo '0')"
          echo "  æœ€è¿‘æäº¤: $(git log --oneline -1 2>/dev/null || echo 'æ— æäº¤è®°å½•')"

      - name: 7. æ‰§è¡Œé•œåƒåŒæ­¥
        run: |
          set -e
          
          cd meta-rules-dat.git
          
          echo "=== å¼€å§‹åŒæ­¥é•œåƒä»“åº“ $(date '+%Y-%m-%d %H:%M:%S') ==="
          
          # æ°¸ä¹…æ€§é…ç½®ï¼šåªæŠ“å–åˆ†æ”¯å’Œæ ‡ç­¾
          echo "é…ç½®æºä»“åº“åªæŠ“å–åˆ†æ”¯å’Œæ ‡ç­¾..."
          git config --unset-all remote.origin.fetch 2>/dev/null || true
          git config --add remote.origin.fetch '+refs/heads/*:refs/heads/*'
          git config --add remote.origin.fetch '+refs/tags/*:refs/tags/*'
          
          # æ¸…ç†åŽ†å²é—ç•™çš„PRå¼•ç”¨
          echo "æ¸…ç†PRå¼•ç”¨..."
          {
              git for-each-ref --format='delete %(refname)' refs/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— æœ¬åœ°PRå¼•ç”¨å¯æ¸…ç†"
          
          {
              git for-each-ref --format='delete %(refname)' refs/remotes/origin/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— è¿œç¨‹PRå¼•ç”¨å¯æ¸…ç†"
          
          # èŽ·å–æœ€æ–°æ›´æ–°
          echo "ä»Žæºä»“åº“èŽ·å–æœ€æ–°æ›´æ–°..."
          if git fetch --prune origin; then
            echo "âœ… èŽ·å–æˆåŠŸ"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹éœ€è¦æŽ¨é€
            if git log --oneline HEAD..origin/HEAD 2>/dev/null | head -5; then
              echo "æœ‰æ–°çš„æäº¤éœ€è¦åŒæ­¥"
            else
              if [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
                echo "âš ï¸ æ²¡æœ‰æ–°æäº¤ï¼Œä½†å¼ºåˆ¶åŒæ­¥æ¨¡å¼å·²å¼€å¯"
              else
                echo "âœ… æºä»“åº“æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡åŒæ­¥"
                echo "å¦‚æžœéœ€è¦å¼ºåˆ¶åŒæ­¥ï¼Œè¯·æ‰‹åŠ¨è§¦å‘å¹¶é€‰æ‹©'å¼ºåˆ¶åŒæ­¥: true'"
                exit 0
              fi
            fi
          else
            echo "âŒ èŽ·å–å¤±è´¥"
            exit 1
          fi
          
          # ç›®æ ‡ä»“åº“åˆ—è¡¨
          TARGET_REPOS=(
            "git@github-t:timeflysoon/meta-rules-dat.git"
            "git@github-x1:88alt/meta-rules-dat.git"
          )
          
          # æŽ¨é€åˆ°æ‰€æœ‰ç›®æ ‡ä»“åº“
          for TARGET_REPO in "${TARGET_REPOS[@]}"; do
            REPO_HOST=$(echo "$TARGET_REPO" | cut -d'@' -f2 | cut -d':' -f1)
            REPO_PATH=$(echo "$TARGET_REPO" | cut -d':' -f2)
            
            echo "=== æŽ¨é€é•œåƒåˆ°: $REPO_HOST/$REPO_PATH ==="
            
            # è®°å½•å¼€å§‹æ—¶é—´
            START_TIME=$(date +%s)
            
            MAX_RETRY=2
            for i in $(seq 1 $MAX_RETRY); do
              echo "æŽ¨é€å°è¯• $i/$MAX_RETRY..."
              if git push --mirror "$TARGET_REPO"; then
                # è®¡ç®—æŽ¨é€æ—¶é—´
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                
                # ç»Ÿè®¡æŽ¨é€å†…å®¹
                BRANCHES_COUNT=$(git branch -r | wc -l)
                TAGS_COUNT=$(git tag | wc -l)
                
                echo "âœ… æŽ¨é€æˆåŠŸ"
                echo "  æŽ¨é€ç»Ÿè®¡: $BRANCHES_COUNT ä¸ªåˆ†æ”¯, $TAGS_COUNT ä¸ªæ ‡ç­¾"
                echo "  æŽ¨é€è€—æ—¶: ${DURATION}ç§’"
                break
              elif [ $i -eq $MAX_RETRY ]; then
                echo "âŒ æŽ¨é€å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
                echo "::warning::æŽ¨é€ $REPO_PATH å¤±è´¥"
                # è®°å½•å¤±è´¥ä½†ä¸é€€å‡ºï¼Œç»§ç»­å°è¯•å…¶ä»–ä»“åº“
                break
              else
                echo "æŽ¨é€å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
                sleep 10
              fi
            done
          done
          
          echo "=== åŒæ­¥å®Œæˆ $(date '+%Y-%m-%d %H:%M:%S') ==="

      - name: 8. æ¸…ç†æ•æ„Ÿæ•°æ®
        if: always()
        run: |
          echo "æ¸…ç†SSHå¯†é’¥æ–‡ä»¶..."
          rm -f ~/.ssh/id_ed25519_t
          rm -f ~/.ssh/id_ed25519_x1
          rm -f ~/.ssh/config
          rm -f ~/.ssh/known_hosts
          
          echo "âœ… æ•æ„Ÿæ•°æ®æ¸…ç†å®Œæˆ"

      - name: 9. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸš€ é•œåƒåŒæ­¥ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬è¿è¡Œä¿¡æ¯
          echo "### ðŸ“Š è¿è¡Œæ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»»åŠ¡çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡ŒID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æºä»“åº“ä¿¡æ¯
          echo "### ðŸ“¦ æºä»“åº“ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: \`${{ env.source_repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŒæ­¥ç›®æ ‡
          echo "### ðŸŽ¯ åŒæ­¥ç›®æ ‡" >> $GITHUB_STEP_SUMMARY
          echo "| ä»“åº“ | SSHå¯†é’¥ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| timeflysoon/meta-rules-dat | å¯†é’¥T | å¾…æ‰§è¡Œ |" >> $GITHUB_STEP_SUMMARY
          echo "| 88alt/meta-rules-dat | å¯†é’¥X1 | å¾…æ‰§è¡Œ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "### âœ… æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰é•œåƒåŒæ­¥å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
            echo "é•œåƒåŒæ­¥ä»»åŠ¡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—æŽ’æŸ¥é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')*" >> $GITHUB_STEP_SUMMARY
